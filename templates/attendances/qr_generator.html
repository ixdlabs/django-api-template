{% load static %}
<!DOCTYPE html>
<html data-theme="light" lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta
      name="viewport"
      content="width=device-width, user-scalable=no, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0"
    />
    <meta http-equiv="X-UA-Compatible" content="ie=edge" />
    <link rel="stylesheet" href="{% static 'theme.css' %}" />
    <title>QR Generator Demo</title>
  </head>

  <body style="padding: 20px">
    <div id="app">
      <h1>QR Generator Demo</h1>

      <!-- QR_STEP: Membership ID Entry ------------------------------------------------------------------------------->
      <form v-if="state === 'QR_INPUT'">
        <h2>Enter Membership ID</h2>
        <input type="text" v-model="membershipId" placeholder="Membership ID" />
        <button type="button" @click="beginQrFlow">Generate QR</button>
      </form>

      <!-- QR_DISPLAY: QR Code Showing -------------------------------------------------------------------------------->
      <div v-if="state === 'QR_DISPLAY'">
        <h2>QR Code</h2>
        <div style="padding: 20px; background: white">
          <img
            :src="'https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=' + encodeURIComponent(qrToken)"
            alt="QR"
          />
        </div>
        <p style="font-family: monospace">Token: [[ qrToken ]]</p>
        <button @click="state = 'QR_INPUT'">Back</button>
      </div>

      <!-- Logs ------------------------------------------------------------------------------------------------------->
      <details style="padding: 8px">
        <summary>Logs will show up here</summary>
        <div v-for="log in logs" style="font-family: monospace; padding: 2px">
          <span v-if="log.type === 'info'">ðŸ”µ</span>
          <span v-if="log.type === 'warn'">ðŸŸ¡</span>
          <span v-if="log.type === 'error'">ðŸ”´</span>
          <span v-if="log.type === 'log'">âš«</span>
          <span>&nbsp;[[ log.time ]]&nbsp;</span>
          <span>[[ log.message ]]</span>
        </div>
      </details>
    </div>

    <!-- Scripts ------------------------------------------------------------------------------------------------------>
    <script src="{% static 'vue.global.js' %}"></script>
    <script src="{% static 'jwt_encode.js' %}"></script>
    {{ membership_secrets|json_script:"membership_secrets" }}

    <script>
      const { createApp, computed, ref } = Vue;
      const state = ref("QR_INPUT");

      createApp({
        delimiters: ["[[", "]]"],
        setup() {
          // State variables -------------------------------------------------------------------------------------------
          const membershipId = ref("");
          const qrToken = ref("");
          const qrSecret = ref("");
          const qrRefreshTimer = ref(null);

          // Logging ---------------------------------------------------------------------------------------------------
          const logs = ref([]);

          function addLog(type = null, ...messages) {
            const message = messages.map((x) => (typeof x === "object" ? JSON.stringify(x) : x)).join(" ");
            const timeNow = new Date();
            const time = `${timeNow.getHours()}:${timeNow.getMinutes()}:${timeNow.getSeconds()}`;
            logs.value = [{ type, time, message }, ...logs.value];
          }

          // Fetch QR Token --------------------------------------------------------------------------------------------
          async function loadQrToken() {
            const payload = { sub: membershipId.value };
            qrToken.value = await jwtEncode(payload, qrSecret.value);

            // Schedule next refresh
            if (qrRefreshTimer.value) clearTimeout(qrRefreshTimer.value);
            qrRefreshTimer.value = setTimeout(loadQrToken, 15000); // 15s
          }

          // Begin QR Flow ---------------------------------------------------------------------------------------------
          async function beginQrFlow() {
            const membershipSecrets = JSON.parse(document.getElementById("membership_secrets").textContent);
            if (membershipSecrets[membershipId.value]) {
              qrSecret.value = membershipSecrets[membershipId.value];
              await loadQrToken();
              state.value = "QR_DISPLAY";
            } else {
              addLog("error", "Membership ID is not valid");
            }
          }

          // Exposed values --------------------------------------------------------------------------------------------
          return {
            state,
            logs,
            membershipId,
            qrToken,
            qrSecret,

            beginQrFlow,
            addLog,
          };
        },
      }).mount("#app");
    </script>
  </body>
</html>
